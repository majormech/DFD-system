(()=>{let e=null,t=!1,n=null;function r(e){const t=document.querySelector("#scanStatus");t&&(t.textContent=e||"")}function a(e){return String(e||"").trim().toUpperCase()}function o(e){const t=document.querySelector("#apparatus");if(!t)return null;const n=a(e),r=n.match(/[A-Z]-\d+/g),o=r?.length?r:[n],i=Array.from(t.options||[]);for(const e of o){const t=i.find(t=>a(t.value)===e||a(t.textContent||"")===e||a(t.textContent||"").includes(e));if(t)return t.value}return null}async function i({onSelect:i,onStatus:s}){if(!("BarcodeDetector"in window))return r("Barcode scanning not supported on this device."),void s?.("Barcode scanning not supported on this device.");if(!navigator.mediaDevices?.getUserMedia)return r("Camera access is not available."),void s?.("Camera access is not available.");const c=document.querySelector("#scanBackdrop"),u=document.querySelector("#scanVideo");if(!c||!u)return;n=n||new BarcodeDetector({formats:["qr_code","code_128","code_39","codabar"]}),t=!0,c.classList.add("show"),c.setAttribute("aria-hidden","false"),r("Starting camera…");try{e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}),u.srcObject=e,await u.play(),r("Scanning…"),requestAnimationFrame(()=>l({onSelect:i,onStatus:s}))}catch(e){r(`Camera error: ${e?.message||e}`),s?.(`Camera error: ${e?.message||e}`),d()}}function d(){t=!1;const n=document.querySelector("#scanBackdrop"),a=document.querySelector("#scanVideo");n&&(n.classList.remove("show"),n.setAttribute("aria-hidden","true")),a&&(a.pause(),a.srcObject=null),e&&(e.getTracks().forEach(e=>e.stop()),e=null),r("")}async function l({onSelect:e,onStatus:r}){if(!t||!n)return;const a=document.querySelector("#scanVideo");if(!a)return;try{const t=await n.detect(a);if(t?.length){const n=t[0].rawValue||t[0].rawValueText||"",a=o(n);if(a)return e?.(a),void d();r(`Scanned ${n}. No matching apparatus found.`)}}catch{}requestAnimationFrame(()=>l({onSelect:e,onStatus:r}))}window.DFDScanner={startScanner:i,stopScanner:d}})();
