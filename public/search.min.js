const $=s=>document.querySelector(s);function toast(e,t=2200){const n=$("#toast");$("#toastText").textContent=e||"OK",n.classList.add("show"),setTimeout(()=>n.classList.remove("show"),t)}async function apiGet(e){const t=new URLSearchParams(e),n=await fetch(`/api?${t.toString()}`,{method:"GET"}),r=await n.text();let a;try{a=JSON.parse(r)}catch{throw new Error(`Bad JSON from /api: ${r.slice(0,200)}`)}if(!a.ok)throw new Error(a.error||"Request failed");return a}async function apiPost(e){const t=await fetch(`/api`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)}),n=await t.text();let r;try{r=JSON.parse(n)}catch{throw new Error(`Bad JSON from /api: ${n.slice(0,200)}`)}if(!r.ok)throw new Error(r.error||"Request failed");return r}let META=null,CURRENT_RESULTS=[],FILTERED_RESULTS=[];function ymdTodayLocal(){const e=new Date,t=e=>String(e).padStart(2,"0");return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}`}function fmtLocal(e){try{const t=new Date(e);return isNaN(t.getTime())?e||"":t.toLocaleString()}catch{return e||""}}function escapeHtml(e){return String(e??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function normalizeText(e){return String(e||"").toLowerCase()}function safeUuid(){return crypto?.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}function attentionLevelForRow(e){const t=normalizeText(`${e.category||""} ${e.summary||""} ${e.submitter||""}`);return/(out of service|oos|critical|expired|missing|failed|failure)/.test(t)?"critical":/(fail|needs mechanic|broken|leak|not working|immediate)/.test(t)?"high":/(warning|maintenance|service|needs attention|soon|low)/.test(t)?"medium":"low"}function setStationOptions(e){const t=$("#stationId");t.innerHTML=`<option value="all">All Stations</option>`+(e.stations||[]).map(e=>`<option value="${escapeHtml(e.stationId)}">${escapeHtml(e.stationName)}</option>`).join("")}function setApparatusOptions(e,t){const n=$("#apparatusId");let r=[];if(t&&"all"!==t){const a=(e.stations||[]).find(e=>String(e.stationId)===String(t));r=a&&a.apparatus?a.apparatus:[]}else{const t=new Map;(e.stations||[]).forEach(e=>{(e.apparatus||[]).forEach(e=>t.set(e.apparatusId,e))}),r=Array.from(t.values()).sort((e,t)=>String(e.apparatusId).localeCompare(String(t.apparatusId),void 0,{numeric:!0,sensitivity:"base"}))}n.innerHTML=`<option value="all">All Apparatus</option>`+r.map(e=>{const t=String(e.apparatusId||"").trim(),n=String(e.apparatusName||e.apparatusId||"").trim();return`<option value="${escapeHtml(t)}">${escapeHtml(n)}</option>`}).join("")}function renderResults(e){const t=$("#results tbody");if(t.innerHTML="",!e||!e.length)return t.innerHTML=`<tr><td colspan="6" class="note">No matches.</td></tr>`,$("#resultCount").textContent="0 results",void 0;$("#resultCount").textContent=`${e.length} result(s)`;for(const n of e){const e=document.createElement("tr"),t=attentionLevelForRow(n),r=t[0].toUpperCase()+t.slice(1);e.innerHTML=`\n      <td data-label="Timestamp">${escapeHtml(fmtLocal(n.timestamp))}</td>\n      <td data-label="Station">${escapeHtml(n.stationId||"")}</td>\n      <td data-label="Apparatus">${escapeHtml(n.apparatusId||"")}</td>\n      <td data-label="Category">${escapeHtml(n.category||"")}</td>\n      <td data-label="Submitter">${escapeHtml(n.submitter||"")}</td>\n      <td data-label="Summary">\n        ${escapeHtml(String(n.summary||""))}\n        <span class="pill priority-${escapeHtml(t)}" style="margin-left:6px">${escapeHtml(r)}</span>\n      </td>\n    `,t.appendChild(e)}}async function loadMeta(){const e=await apiPost({action:"getSearchMeta"});META=e.meta,setStationOptions(META),setApparatusOptions(META,"all")}function labelCategory_(e){const t={apparatusDaily:"Apparatus Daily",medicalDaily:"Medical Daily",scbaWeekly:"SCBA Weekly",pumpWeekly:"Pump Weekly",aerialWeekly:"Aerial Weekly",sawWeekly:"Saws Weekly",batteriesWeekly:"Batteries Weekly",oosUnit:"Out of Service Units",oosEquipment:"Out of Service Equipment",issues:"Issues",medAlerts:"Drug Expiration Email Alerts"};return t[e]||e||""}const ALL_CATEGORIES=["apparatusDaily","medicalDaily","scbaWeekly","pumpWeekly","aerialWeekly","sawWeekly","batteriesWeekly","oosUnit","oosEquipment","issues","medAlerts"],TEMPLATE_KEY="dfd_search_templates_v1";function loadTemplates(){try{const e=localStorage.getItem(TEMPLATE_KEY),t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function saveTemplates(e){localStorage.setItem(TEMPLATE_KEY,JSON.stringify(e))}function refreshTemplateOptions(){const e=$("#templateSelect");if(!e)return;const t=loadTemplates();e.innerHTML=`<option value="">Select template…</option>`+t.map(e=>`<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>`).join("")}function currentFilters(){return{stationId:$("#stationId").value||"all",apparatusId:$("#apparatusId").value||"all",category:$("#category").value||"all",from:$("#from").value||"",to:$("#to").value||"",q:($("#q").value||"").trim(),limit:$("#limit").value||"200",priority:$("#priorityFilter").value||"all",periodPreset:$("#periodPreset").value||""}}function applyTemplate(e){e&&($("#stationId").value=e.stationId||"all",setApparatusOptions(META,$("#stationId").value),$("#apparatusId").value=e.apparatusId||"all",$("#category").value=e.category||"all",$("#from").value=e.from||"",$("#to").value=e.to||"",$("#q").value=e.q||"",$("#limit").value=e.limit||"200",$("#priorityFilter").value=e.priority||"all",$("#periodPreset").value=e.periodPreset||"")}function applyPeriodPreset(e){const t=new Date,n=e=>String(e).padStart(2,"0"),r=e=>`${e.getFullYear()}-${n(e.getMonth()+1)}-${n(e.getDate())}`;let a="",o=r(t);const i=new Date(t);switch(e){case"today":a=o;break;case"last7":i.setDate(i.getDate()-6),a=r(i);break;case"last30":i.setDate(i.getDate()-29),a=r(i);break;case"last90":i.setDate(i.getDate()-89),a=r(i);break;case"monthToDate":i.setDate(1),a=r(i);break;case"yearToDate":i.setMonth(0,1),a=r(i);break;case"lastMonth":{const e=new Date(t.getFullYear(),t.getMonth()-1,1),n=new Date(t.getFullYear(),t.getMonth(),0);a=r(e),o=r(n);break}default:return}$("#from").value=a,$("#to").value=o}function applyClientFilters(e){const t=$("#priorityFilter").value||"all";return"all"===t?e:e.filter(e=>attentionLevelForRow(e)===t)}function renderSummary(e){const t=$("#summaryGrid"),n=$("#summaryRange");if(!t||!n)return;if(!e.length)return t.innerHTML=`<div class="summaryCard note">No data to summarize.</div>`,n.textContent="—",void 0;const r=$("#from").value||"Any",a=$("#to").value||"Any";n.textContent=`Range: ${r} → ${a}`;const o=e.reduce((e,t)=>(e[attentionLevelForRow(t)]=(e[attentionLevelForRow(t)]||0)+1,e),{}),i=e.reduce((e,t)=>(e[t.category||"Uncategorized"]=(e[t.category||"Uncategorized"]||0)+1,e),{}),s=Object.entries(i).sort((e,t)=>t[1]-e[1]).slice(0,5);t.innerHTML=`\n    <div class="summaryCard">\n      <div class="note">Total Records</div>\n      <div style="font-size:22px;font-weight:900">${e.length}</div>\n    </div>\n    <div class="summaryCard">\n      <div class="note">Critical</div>\n      <div class="pill priority-critical">${o.critical||0}</div>\n    </div>\n    <div class="summaryCard">\n      <div class="note">High</div>\n      <div class="pill priority-high">${o.high||0}</div>\n    </div>\n    <div class="summaryCard">\n      <div class="note">Medium</div>\n      <div class="pill priority-medium">${o.medium||0}</div>\n    </div>\n    <div class="summaryCard">\n      <div class="note">Low</div>\n      <div class="pill priority-low">${o.low||0}</div>\n    </div>\n    <div class="summaryCard" style="grid-column:1/-1">\n      <div class="note" style="margin-bottom:6px">Top Categories</div>\n      ${s.map(e=>`<div style="display:flex;justify-content:space-between;font-weight:700">\n              <span>${escapeHtml(e[0])}</span><span>${e[1]}</span>\n            </div>`).join("")}\n    </div>\n  `}function renderTrends(e){const t=$("#trendList");if(!t)return;if(!e.length)return void(t.textContent="No data to trend.");const n=new Map;e.forEach(e=>{const t=new Date(e.timestamp||"");if(isNaN(t.getTime()))return;const r=t.toISOString().slice(0,10);n.set(r,(n.get(r)||0)+1)});const r=Array.from(n.entries()).sort((e,t)=>e[0].localeCompare(t[0])),a=Math.max(...r.map(e=>e[1]),1);t.innerHTML=r.map(e=>{const t=Math.max(6,Math.round(e[1]/a*100));return`\n        <div class="trendRow">\n          <div>${escapeHtml(e[0])}</div>\n          <div class="trendBar" style="width:${t}%"></div>\n          <div style="text-align:right;font-weight:800">${e[1]}</div>\n        </div>\n      `}).join("")}function downloadBlob(e,t,n){const r=new Blob([e],{type:n}),a=URL.createObjectURL(r),o=document.createElement("a");o.href=a,o.download=t,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(a)}function exportCsv(e){if(!e.length)return toast("No data to export");const t=["Timestamp","Station","Apparatus","Category","Submitter","Summary"],n=[t.join(","),...e.map(e=>[fmtLocal(e.timestamp),e.stationId||"",e.apparatusId||"",e.category||"",e.submitter||"",String(e.summary||"").replaceAll('"','""')].map(e=>`"${String(e).replaceAll('"','""')}"`).join(","))];downloadBlob(n.join("\n"),"dfd-report.csv","text/csv;charset=utf-8;")}function exportExcel(e){if(!e.length)return toast("No data to export");const t=e.map(e=>`\n      <tr>\n        <td>${escapeHtml(fmtLocal(e.timestamp))}</td>\n        <td>${escapeHtml(e.stationId||"")}</td>\n        <td>${escapeHtml(e.apparatusId||"")}</td>\n        <td>${escapeHtml(e.category||"")}</td>\n        <td>${escapeHtml(e.submitter||"")}</td>\n        <td>${escapeHtml(String(e.summary||""))}</td>\n      </tr>`).join(""),n=`\n    <table>\n      <thead>\n        <tr>\n          <th>Timestamp</th>\n          <th>Station</th>\n          <th>Apparatus</th>\n          <th>Category</th>\n          <th>Submitter</th>\n          <th>Summary</th>\n        </tr>\n      </thead>\n      <tbody>${t}</tbody>\n    </table>\n  `;downloadBlob(n,"dfd-report.xls","application/vnd.ms-excel")}async function runSearch(){const e=$("#stationId").value||"all",t=$("#apparatusId").value||"all",n=$("#category").value||"all",r=$("#from").value||"",a=$("#to").value||"",o=($("#q").value||"").trim(),i=Number($("#limit").value||200);if("all"!==n){const t=await apiGet({action:"searchRecords",stationId:e,apparatusId:t,category:n,from:r,to:a,q:o,limit:i}),s=(t.results||[]).map(e=>({...e,category:labelCategory_(e.category||n)}));return CURRENT_RESULTS=s,FILTERED_RESULTS=applyClientFilters(s),renderResults(FILTERED_RESULTS),renderSummary(FILTERED_RESULTS),void renderTrends(FILTERED_RESULTS)}const s=Math.max(25,Math.floor(i/3)),l=ALL_CATEGORIES.map(n=>apiGet({action:"searchRecords",stationId:e,apparatusId:t,category:n,from:r,to:a,q:o,limit:String(s)}).then(e=>(e.results||[]).map(e=>({...e,category:e.category||n}))).catch(()=>[])),c=await Promise.all(l);let u=c.flat();u.sort((e,t)=>new Date(t.timestamp||0).getTime()-new Date(e.timestamp||0).getTime()),u=u.slice(0,i),u=u.map(e=>({...e,category:labelCategory_(e.category)})),CURRENT_RESULTS=u,FILTERED_RESULTS=applyClientFilters(u),renderResults(FILTERED_RESULTS),renderSummary(FILTERED_RESULTS),renderTrends(FILTERED_RESULTS)}async function boot(){$("#btnPrint").addEventListener("click",()=>window.print()),$("#btnExportCsv").addEventListener("click",()=>exportCsv(FILTERED_RESULTS)),$("#btnExportExcel").addEventListener("click",()=>exportExcel(FILTERED_RESULTS)),$("#btnExportPdf").addEventListener("click",()=>window.print()),$("#stationId").addEventListener("change",()=>{META&&setApparatusOptions(META,$("#stationId").value)}),$("#periodPreset").addEventListener("change",e=>{applyPeriodPreset(e.target.value)}),$("#priorityFilter").addEventListener("change",()=>{FILTERED_RESULTS=applyClientFilters(CURRENT_RESULTS),renderResults(FILTERED_RESULTS),renderSummary(FILTERED_RESULTS),renderTrends(FILTERED_RESULTS)}),$("#btnSaveTemplate").addEventListener("click",()=>{const e=($("#templateName").value||"").trim();if(!e)return toast("Template name required");const t=loadTemplates(),n=safeUuid();t.push({id:n,name:e,...currentFilters()}),saveTemplates(t),$("#templateName").value="",refreshTemplateOptions(),toast("Template saved")}),$("#btnDeleteTemplate").addEventListener("click",()=>{const e=$("#templateSelect").value;if(!e)return toast("Select a template");const t=loadTemplates().filter(t=>t.id!==e);saveTemplates(t),refreshTemplateOptions(),toast("Template deleted")}),$("#templateSelect").addEventListener("change",()=>{const e=$("#templateSelect").value;if(!e)return;const t=loadTemplates().find(t=>t.id===e);applyTemplate(t),toast("Template loaded")}),$("#btnSearch").addEventListener("click",async()=>{try{$("#resultCount").textContent="Searching…",$("#results tbody").innerHTML='<tr><td colspan="6" class="note">Searching…</td></tr>',await runSearch(),toast("Search complete")}catch(e){toast(e.message,3200),$("#resultCount").textContent="—",$("#results tbody").innerHTML=`<tr><td colspan="6" class="note">${escapeHtml(e.message)}</td></tr>`,$("#summaryGrid").innerHTML='<div class="summaryCard note">Search failed.</div>',$("#trendList").textContent="Search failed."}}),$("#to").value=ymdTodayLocal();const e=new Date;e.setDate(e.getDate()-7);const t=e=>String(e).padStart(2,"0");$("#from").value=`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}`;try{await loadMeta(),refreshTemplateOptions(),toast("Loaded")}catch(e){toast(e.message,3200)}}document.addEventListener("DOMContentLoaded",boot);
